services:
  collector:
    image: otel/opentelemetry-collector:0.135.0
    container_name: collector
    command: ["--config=/etc/collector.yaml"]
    volumes:
      - ${COLLECTOR_CONFIG:-./lgtm/config/collector.yaml}:/etc/collector.yaml:ro
    ports:
      - "127.0.0.1:55679:55679" # OTLP zPages
      - "127.0.0.1:4317:4317"   # OTLP gRPC ingest
      - "127.0.0.1:4318:4318"   # OTLP HTTP ingest
    depends_on:
      - mimir
      - tempo
      - loki

  grafana:
    image: grafana/grafana:12.1
    container_name: grafana
    user: root
    volumes:
      - ./lgtm/config/datasources:/etc/grafana/provisioning/datasources
      - ${GRAFANA_DATA:-./lgtm/data/grafana}:/var/lib/grafana
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - mimir
      - tempo
      - loki

  mimir:
    image: grafana/mimir:2.17.1
    container_name: mimir
    command: ["-config.file=/etc/mimir.yaml"]
    user: root
    volumes:
      - ${MIMIR_CONFIG:-./lgtm/config/mimir.yaml}:/etc/mimir.yaml:ro
      - ${MIMIR_DATA:-./lgtm/data/mimir}:/tmp/mimir
    ports:
      - "127.0.0.1:8080:8080"

  tempo:
    image: grafana/tempo:2.8.2
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    user: root
    volumes:
      - ${TEMPO_CONFIG:-./lgtm/config/tempo.yaml}:/etc/tempo.yaml:ro
      - ${TEMPO_DATA:-./lgtm/data/tempo}:/tmp/tempo
    ports:
      - "127.0.0.1:3200:3200"

  loki:
    image: grafana/loki:3.5
    container_name: loki
    command: ["-config.file=/etc/loki.yaml"]
    user: root
    volumes:
      - ${LOKI_CONFIG:-./lgtm/config/loki.yaml}:/etc/loki.yaml:ro
      - ${LOKI_DATA:-./lgtm/data/loki}:/tmp/loki
    ports:
      - "127.0.0.1:3100:3100"
